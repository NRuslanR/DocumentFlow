with get_11385384_info as (select
a.type_id,
c.stage_number
from doc.service_notes a
join doc.document_types b on a.type_id = b.id
join doc.document_type_work_cycle_stages c on c.id = a.current_work_cycle_stage_id
where
(a.author_id is not null) and
(
(a.author_id = 1355)
or
doc.is_employee_acting_for_other_or_vice_versa(1355, a.author_id)
or
doc.are_employees_with_given_roles_of_same_leader(array[a.author_id, 1355], array[3,4,6])
or
doc.is_employee_secretary_for_other_or_vice_versa(1355, a.author_id)
)
or exists
(
select
1
from
doc.service_note_receivers rec
where
(receiver_category = 1)
and
(outside_document_id=a.outside_id)
and

(
case when (rec.outside_employee_id=1355
or
doc.is_employee_acting_for_other_or_vice_versa(1355, rec.outside_employee_id)
or
doc.are_employees_subleaders_of_same_leader(array[rec.outside_employee_id, 1355])
)
then c.stage_number not in (1,6)
else true
end )),get_11385480_info as (with incoming_service_notes as (
select
row_number() over (partition by b.outside_document_id order by case when b.outside_employee_id = 1355 then 0 else 1 end) as charge_number,
b.id,
b.service_note_type_id as type_id,
d.stage_number,
exists(select 1 from doc.service_note_receivers where sender_id = b.id) as are_subordinate_charges_exists
from doc.service_notes a
join doc.service_note_receivers b on a.outside_id = b.outside_document_id
join doc.document_type_work_cycle_stages d on d.id = b.current_work_cycle_stage_id
where
(
(b.current_work_cycle_stage_id is not null) and
(b.outside_employee_id = 1355
or doc.is_employee_acting_for_other_or_vice_versa(1355, b.outside_employee_id)
or or doc.are_employees_subleaders_of_same_leader(array[1355, b.outside_employee_id])
))
)
select
id,
type_id, 
stage_number,
are_subordinate_charges_exists
from incoming_service_notes
where charge_number = 1) select distinct 
type_id,
count(case when stage_number in (1,5) then 1 else null end) over () as own_action_count,
count(case when stage_number in (7) then 1 else null end) over () as in_working_count
from
get_11385384_info
 union select distinct
type_id,
count(case when (stage_number in (1) and not are_subordinate_charges_exists) then 1 else null end)
 over () as own_action_count,
count(case when (stage_number in (1)) then 1 else null end) over () as in_working_count
from
get_11385480_info a
