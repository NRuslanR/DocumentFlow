WITH RECURSIVE get_all_top_level_employees (id,spr_person_id,name,surname,patronymic,speciality,personnel_number,telephone_number,department_id,leader_id,is_foreign,was_dismissed,head_kindred_department_id,role_id,role_name,role_description,email,eewg1_work_group_id,eewg1_employee_id,emp2_id,emp2_name,emp2_name,emp2_surname,emp2_patronymic,emp2_speciality,emp2_personnel_number,emp2_telephone_number,emp2_department_id,emp2_leader_id,emp2_is_foreign,emp2_was_dismissed,r2_id,r2_name,r2_description,pe2_email,eewg2_work_group_id,eewg2_employee_id,level) AS (SELECT emp1.id,emp1.spr_person_id,emp1.name,emp1.surname,emp1.patronymic,emp1.speciality,emp1.personnel_number,emp1.telephone_number,emp1.department_id,emp1.leader_id,emp1.is_foreign,emp1.was_dismissed,emp1.head_kindred_department_id,doc.roles.id as role_id,doc.roles.name as role_name,doc.roles.description as role_description,exchange.person_email.email,doc.employees_employee_work_groups.work_group_id as eewg1_work_group_id,doc.employees_employee_work_groups.employee_id as eewg1_employee_id,emp2.id as emp2_id,emp2.spr_person_id as emp2_name,emp2.name as emp2_name,emp2.surname as emp2_surname,emp2.patronymic as emp2_patronymic,emp2.speciality as emp2_speciality,emp2.personnel_number as emp2_personnel_number,emp2.telephone_number as emp2_telephone_number,emp2.department_id as emp2_department_id,emp2.leader_id as emp2_leader_id,emp2.is_foreign as emp2_is_foreign,emp2.was_dismissed as emp2_was_dismissed,r2.id as r2_id,r2.name as r2_name,r2.description as r2_description,pe2.email as pe2_email,eewg2.work_group_id as eewg2_work_group_id,eewg2.employee_id as eewg2_employee_id,0 as level FROM doc.employees as emp1 LEFT JOIN doc.employees_roles as er1 ON er1.employee_id=emp1.id LEFT JOIN doc.roles ON doc.roles.id=er1.role_id LEFT JOIN exchange.person_email ON exchange.person_email.person_id=emp1.spr_person_id LEFT JOIN doc.employees_employee_work_groups ON doc.employees_employee_work_groups.employee_id=emp1.id LEFT JOIN doc.employees as emp2 ON emp2.id=emp1.leader_id LEFT JOIN doc.employees_roles as er2 ON er2.employee_id=emp2.id LEFT JOIN doc.roles as r2 ON r2.id=er2.role_id LEFT JOIN exchange.person_email as pe2 ON pe2.person_id=emp2.spr_person_id LEFT JOIN doc.employees_employee_work_groups as eewg2 ON eewg2.employee_id=emp2.id JOIN doc.employees b ON b.leader_id=emp1.id WHERE b.id=1356 AND b.head_kindred_department_id=emp1.head_kindred_department_id UNION SELECT emp1.id,emp1.spr_person_id,emp1.name,emp1.surname,emp1.patronymic,emp1.speciality,emp1.personnel_number,emp1.telephone_number,emp1.department_id,emp1.leader_id,emp1.is_foreign,emp1.was_dismissed,emp1.head_kindred_department_id,doc.roles.id as role_id,doc.roles.name as role_name,doc.roles.description as role_description,exchange.person_email.email,doc.employees_employee_work_groups.work_group_id as eewg1_work_group_id,doc.employees_employee_work_groups.employee_id as eewg1_employee_id,emp2.id as emp2_id,emp2.spr_person_id as emp2_name,emp2.name as emp2_name,emp2.surname as emp2_surname,emp2.patronymic as emp2_patronymic,emp2.speciality as emp2_speciality,emp2.personnel_number as emp2_personnel_number,emp2.telephone_number as emp2_telephone_number,emp2.department_id as emp2_department_id,emp2.leader_id as emp2_leader_id,emp2.is_foreign as emp2_is_foreign,emp2.was_dismissed as emp2_was_dismissed,r2.id as r2_id,r2.name as r2_name,r2.description as r2_description,pe2.email as pe2_email,eewg2.work_group_id as eewg2_work_group_id,eewg2.employee_id as eewg2_employee_id,b.level + 1 as level FROM doc.employees as emp1 LEFT JOIN doc.employees_roles as er1 ON er1.employee_id=emp1.id LEFT JOIN doc.roles ON doc.roles.id=er1.role_id LEFT JOIN exchange.person_email ON exchange.person_email.person_id=emp1.spr_person_id LEFT JOIN doc.employees_employee_work_groups ON doc.employees_employee_work_groups.employee_id=emp1.id LEFT JOIN doc.employees as emp2 ON emp2.id=emp1.leader_id LEFT JOIN doc.employees_roles as er2 ON er2.employee_id=emp2.id LEFT JOIN doc.roles as r2 ON r2.id=er2.role_id LEFT JOIN exchange.person_email as pe2 ON pe2.person_id=emp2.spr_person_id LEFT JOIN doc.employees_employee_work_groups as eewg2 ON eewg2.employee_id=emp2.id JOIN get_all_top_level_employees b ON b.leader_id=emp1.id WHERE b.head_kindred_department_id=emp1.head_kindred_department_id) SELECT * FROM get_all_top_level_employees ORDER BY level ASC
